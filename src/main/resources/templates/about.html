<!DOCTYPE html>
<!--
    Страница статистики системы
    Автор: Иванов Егор Борисович
-->
<html lang="ru"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Статистика - Юридическая фирма</title>

    <!-- Подключение Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Подключение Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Подключение Chart.js для диаграмм -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Встроенные стили -->
    <style>
        /* Стили для статистических карточек */
        .stat-card {
            transition: transform 0.3s ease;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        /* Иконки */
        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }

        /* Контейнер для диаграмм */
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
<!-- Навигационная панель -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" th:href="@{/}">
            <i class="fas fa-balance-scale"></i> Юридическая фирма
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/dashboard}">
                        <i class="fas fa-tachometer-alt"></i> Панель управления
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" th:href="@{/statistics}">
                        <i class="fas fa-chart-bar"></i> Статистика
                    </a>
                </li>
            </ul>

            <ul class="navbar-nav">
                <li class="nav-item">
                    <form th:action="@{/logout}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-sign-out-alt"></i> Выход
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Основной контент -->
<div class="container-fluid mt-4">
    <!-- Заголовок -->
    <div class="row mb-4">
        <div class="col">
            <h1><i class="fas fa-chart-line"></i> Статистика системы</h1>
            <p class="text-muted">Общая информация о работе системы</p>
        </div>
    </div>

    <!-- Статистические карточки -->
    <div class="row mb-4">
        <!-- Карточка: Всего пользователей -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="fas fa-users stat-icon text-primary"></i>
                    <h3 class="mt-3" th:text="${totalUsers}">0</h3>
                    <p class="text-muted mb-0">Всего пользователей</p>
                </div>
            </div>
        </div>

        <!-- Карточка: Всего дел -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="fas fa-briefcase stat-icon text-success"></i>
                    <h3 class="mt-3" th:text="${totalCases}">0</h3>
                    <p class="text-muted mb-0">Всего дел</p>
                </div>
            </div>
        </div>

        <!-- Карточка: Всего консультаций -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="fas fa-calendar-check stat-icon text-info"></i>
                    <h3 class="mt-3" th:text="${totalConsultations}">0</h3>
                    <p class="text-muted mb-0">Всего консультаций</p>
                </div>
            </div>
        </div>

        <!-- Карточка: Всего документов -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="fas fa-file-alt stat-icon text-warning"></i>
                    <h3 class="mt-3" th:text="${totalDocuments}">0</h3>
                    <p class="text-muted mb-0">Всего документов</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Ключевые показатели -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator"></i> Ключевые показатели
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tbody>
                        <tr>
                            <td><strong>Среднее количество дел на юриста:</strong></td>
                            <td class="text-end">
                                <span class="badge bg-info" th:text="${avgCasesPerLawyer}">0</span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Средняя продолжительность консультации:</strong></td>
                            <td class="text-end">
                                <span class="badge bg-success" th:text="${avgConsultationDuration} + ' мин'">0 мин</span>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Топ юристов -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy"></i> Топ-5 юристов по количеству дел
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <!-- Цикл по топ юристам -->
                        <li class="list-group-item" th:each="entry, iterStat : ${topLawyers}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-primary me-2" th:text="${iterStat.count}">1</span>
                                    <strong th:text="${entry.key.fullName}">Имя юриста</strong>
                                </div>
                                <span class="badge bg-info" th:text="${entry.value} + ' дел'">0 дел</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Диаграммы -->
    <div class="row mb-4">
        <!-- Диаграмма: Дела по статусам -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Распределение дел по статусам
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <!-- Canvas для диаграммы Chart.js -->
                        <canvas id="caseStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Диаграмма: Дела по категориям -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Распределение дел по категориям
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="caseCategoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Детальная статистика по делам -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-briefcase"></i> Статистика по делам
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Статусы дел -->
                        <div class="col-md-6">
                            <h6>По статусам:</h6>
                            <table class="table table-sm">
                                <tbody>
                                <!-- Цикл по статусам -->
                                <tr th:each="entry : ${casesByStatus}">
                                    <td th:text="${entry.key.displayName}">Статус</td>
                                    <td class="text-end">
                                        <span class="badge bg-primary" th:text="${entry.value}">0</span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Категории дел -->
                        <div class="col-md-6">
                            <h6>По категориям:</h6>
                            <table class="table table-sm">
                                <tbody>
                                <!-- Цикл по категориям -->
                                <tr th:each="entry : ${casesByCategory}">
                                    <td th:text="${entry.key.displayName}">Категория</td>
                                    <td class="text-end">
                                        <span class="badge bg-success" th:text="${entry.value}">0</span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Подвал -->
<footer class="mt-5 py-3 bg-light border-top">
    <div class="container text-center">
        <p class="text-muted mb-0">
            &copy; 2025 Информационно-справочная система юридической фирмы
        </p>
    </div>
</footer>

<!-- Подключение Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- JavaScript для построения диаграмм -->
<script th:inline="javascript">
    // Получаем данные из Thymeleaf в JavaScript переменные
    /*<![CDATA[*/

    // Данные для диаграммы статусов дел
    var caseStatusLabels = /*[[${caseStatusChartData.labels}]]*/ [];
    var caseStatusData = /*[[${caseStatusChartData.data}]]*/ [];

    // Данные для диаграммы категорий дел
    var caseCategoryLabels = /*[[${caseCategoryChartData.labels}]]*/ [];
    var caseCategoryData = /*[[${caseCategoryChartData.data}]]*/ [];

    /*]]>*/

    // Функция для инициализации диаграмм после загрузки страницы
    document.addEventListener('DOMContentLoaded', function() {

        // ===== ДИАГРАММА СТАТУСОВ ДЕЛА (круговая) =====

        // Получаем canvas элемент
        var ctxStatus = document.getElementById('caseStatusChart').getContext('2d');

        // Создаем круговую диаграмму
        new Chart(ctxStatus, {
            type: 'pie', // Тип диаграммы: круговая
            data: {
                labels: caseStatusLabels, // Метки из Thymeleaf
                datasets: [{
                    label: 'Количество дел',
                    data: caseStatusData, // Данные из Thymeleaf
                    backgroundColor: [ // Цвета секторов
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)',
                        'rgba(201, 203, 207, 0.8)',
                        'rgba(83, 211, 87, 0.8)'
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true, // Адаптивность
                maintainAspectRatio: false, // Не сохранять пропорции
                plugins: {
                    legend: {
                        position: 'bottom' // Легенда снизу
                    },
                    title: {
                        display: true,
                        text: 'Дела по статусам'
                    }
                }
            }
        });

        // ===== ДИАГРАММА КАТЕГОРИЙ ДЕЛ (столбчатая) =====

        // Получаем canvas элемент
        var ctxCategory = document.getElementById('caseCategoryChart').getContext('2d');

        // Создаем столбчатую диаграмму
        new Chart(ctxCategory, {
            type: 'bar', // Тип диаграммы: столбчатая
            data: {
                labels: caseCategoryLabels,
                datasets: [{
                    label: 'Количество дел',
                    data: caseCategoryData,
                    backgroundColor: 'rgba(255, 159, 64, 0.8)', // Единый цвет для столбцов
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true, // Начинать ось Y с нуля
                        ticks: {
                            stepSize: 1 // Шаг оси (целые числа)
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false // Не показывать легенду
                    },
                    title: {
                        display: true,
                        text: 'Дела по категориям'
                    }
                }
            }
        });
    });
</script>
</body>
</html>